---
title: "Making age structure data by province"
output: html_document
date: "2023-02-24"
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(dplyr)
library(tidyr)
library(purrr)
library(terra)
library(stringr)
library(raster)
library(sf)
```

## Downloading provinces polygons data from GADM

GADM root URL:

```{r}
gadm <- "https://geodata.ucdavis.edu/gadm/"
```

Version and format:

```{r}
vers_form <- "gadm3.6/Rsf/"
```

File:

```{r}
file_name <- "gadm36_VNM_1_sf.rds"
```

Creating the local folder structure if it does not exist:

```{r}
local_folder <- paste0("~/OneDrive - Oxford University Clinical Research Unit/data/GADM/", vers_form)
if (!dir.exists(local_folder)) dir.create(local_folder, recursive = TRUE)
```

Downloading the data if not already available locally:

```{r}
local_file <- paste0(local_folder, file_name)
if (!dir.exists(local_file)) download.file(paste0(gadm, vers_form, file_name), local_file)
```

Loading the polygons data:

```{r}
provinces <- local_file %>%
  readRDS() %>% 
  st_set_crs(4326) # modern name of the WGS 84 projection
```

Checking the map of the provinces polygons:

```{r}
provinces %>% 
  st_geometry() %>% 
  plot()
```

## Downloading demographic raster data from WorldPop

WorldPop URL:

```{r}
worldpop <- "https://data.worldpop.org/"
```

Local data folder:

```{r}
data_folder <- "~/OneDrive - Oxford University Clinical Research Unit/data/WorldPop/"
```

All the combinations of years, ages and gender:

```{r}
combinations <- expand_grid(years = 2000:2020,
                            ages  = c(0, 1, seq(5, 80, 5)),
                            sexes = c("f", "m"))
```

Creating the files names:

```{r}
files_names <- with(combinations,
                    paste0("GIS/AgeSex_structures/Global_2000_2020/",
                           years, "/VNM/vnm_", sexes, "_", ages, "_", years, ".tif"))
```

Creating the folder structure within the data folder if does not exist:

```{r}
dir.create2 <- function(path, ...) {
  if (!dir.exists(path)) dir.create(path, recursive = TRUE, ...)
}

files_names %>% 
  map_chr(str_remove, "/v.*$") %>% 
  unique() %>% 
  paste0(data_folder, .) %>% 
  walk(dir.create2)
```

The remote and local files paths:

```{r}
urls <- paste0(worldpop, files_names)
destfiles <- paste0(data_folder, files_names)
```

Downloading the data:

```{r}
download.file2 <- function(url, destfile, ...) {
  if (!file.exists(destfile)) download.file(url, destfile, ...)
}

walk2(urls, destfiles, download.file2)
```

## Generating province data

A function that converts the polygon of a given province of `provinces` into a
`SpatVector` object:

```{r}
prov2vect <- function(prov_name) {
  provinces %>% 
    filter(VARNAME_1 == prov_name) %>%
    vect()
}
```

A function that crops and masks a `SpatRaster` object `rst` with a `SpatVector`
object `pol`:

```{r}
crop_mask <- function(rst, pol) {
  rst %>%
    crop(pol) %>% 
    mask(pol)
}
```

The names of the provinces:

```{r}
provinces_names <- provinces$VARNAME_1
```

A list of provinces polygons as `SpatVector`:

```{r}
prov_vect_list <- map(provinces_names, prov2vect)
```




```{r}
x <- rast(destfiles[1])
```

```{r}
a <- map(prov_vect_list, crop_mask, rst = x)
```


```{r}
hanoi <- provinces %>% 
  filter(VARNAME_1 == "Ha Noi") %>% 
  vect()
```

```{r}
a %>%
  terra::crop(hanoi) %>% 
  terra::mask(hanoi) %>% 
  plot()
```


